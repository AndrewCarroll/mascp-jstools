<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>GATOR</title>
    <link rel="stylesheet" type="text/css" href="../css/no-theme/jquery-ui-1.7.2.custom.css"/>
<!--    <script language="javascript" type="text/javascript" src="http://getfirebug.com/releases/lite/1.2/firebug-lite.js"></script>-->
    <script type="text/javascript">SVGWEB_PATH='../js/svgweb/';</script>
<!--[if IE 8]>
    <script type="text/javascript" src="../js/svgweb/svg.js" data-path="../js/svgweb/"></script>
<![endif]-->
    <script type="text/javascript" src="../js/maschup.min.js"></script>
    
    <!-- <script type="text/javascript" src="../js/maschup.services.min.js"></script>
    <script type="text/javascript" src="../js/maschup.map.min.js"></script>
    <script type="text/javascript" src="../js/maschup.renderers.min.js"></script> -->

    <!-- <script type="text/javascript" src="../js/lib/gomap.js"></script>
    <script type="text/javascript" src="../js/json-2.js"></script>
    <script type="text/javascript" src="../js/lib/MascpService.js"></script> -->
    <!-- <script type="text/javascript" src="../js/lib/SubaReader.js"></script>
    <script type="text/javascript" src="../js/lib/PhosphatReader.js"></script>
    <script type="text/javascript" src="../js/lib/PromexReader.js"></script>
    <script type="text/javascript" src="../js/lib/TairReader.js"></script>
    <script type="text/javascript" src="../js/lib/AtProteomeReader.js"></script> -->
    <!-- <script type="text/javascript" src="../js/lib/SequenceRenderer.js"></script>    
    <script type="text/javascript" src="../js/lib/CondensedSequenceRenderer.js"></script>    -->

    <script type="text/javascript" charset="utf-8" src="http://code.jquery.com/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="../js/jquery-ui-1.7.2.min.js"></script>

    <style type="text/css">
        body {
            font-family: Verdana, Helvetica, Arial, sans-serif;
            font-size: 11pt;
        }
        
        
        h1 {
            font-family: Gill Sans;
        }
        .track {
            position: relative;
        }
        .mask {
            display: none;
        }

        .active_layer .mask {
            display: block;
        }

        .mask:hover {
            opacity: 0.1;
        }

        #sequence_controllers > li {
            display: none;
        }

        #sequence_controllers {
            position: relative;
            display: block;
            padding: 0px;
            list-style: none;
            height: 100%;
            overflow: auto;            
            left: 0em;
            right: 0px;
        }
        #sequence_control {
            position: relative;
            width: 300px;
            height: 100px;
        }

        #zoom_controls {
            left: 0px;
            bottom: 0px;
            position: relative;
        }

        #suba_results {
            width: 300px;
            height: 230px;
            position: absolute;
            right: 10px;
            top: 75px;
        }
        
        #suba_controller {
            position: absolute;
            right: 100%;
            width: 100px;
            top: 0px;
        }
        
        #atproteome_map {
            position: fixed;
            top: -10000px;
            left: -10000px;
        }
    </style>
</head>

<body>
<div style="width: 50%;">
<h1 style="position: relative;">MASCP AggreGATOR <img style="height: 60px; top: 50%;" src="gator.png" /></h1>
</div>
<div style="margin-bottom: 10px;">
    <label for="agi">Select AGI </label><input id="agi" type="text" name="agi" value="at3g15450.1"/>
</div>
<h2 id="selected_agi"></h2>
<div id="sequence_control">
<ul style="margin-bottom: 10px;" id="sequence_controllers">
    <li id="phosphat_experimental"><input type="checkbox"/> PhosPhAT experimental</li>
    <li id="phosphat_theoretical"><input type="checkbox"/> PhosPhAT theoretical</li>
    <li id="promex_placeholder"><input type="checkbox"/> ProMeX</li>
    <li id="atproteome_placeholder"><input type="checkbox"/> ATProteome</li>
    <li id="hydropathy"><input type="checkbox"/> Hydropathy plot</li>
</ul>
</div>
<div style="position: absolute; left: 10px; top: 300px; bottom: 0px; right: 10px;">
<div style="overflow: auto; width: auto; height: 100%;">
<div id="condensed_container"></div>
<div id="hydropathy_container" style="margin-bottom: 10px;">
</div>
</div>
</div>
<div id="sequence_container" style="font-family: monospace;">
</div>
<div id="suba_results">
</div>
<div id="atproteome_map"></div>
<script type="text/javascript">
//<[CDATA[ 
    window.onload = null;
    
    jQuery(document).ready(function() {        
        if (MASCP.IE) {
            MASCP.renderer = new MASCP.SequenceRenderer(document.getElementById('sequence_container'));
        } else {
            MASCP.renderer = new MASCP.CondensedSequenceRenderer(document.getElementById('condensed_container'));
            var zoom_controls = GOMap.Diagram.addZoomControls(MASCP.renderer);
            zoom_controls.id = 'zoom_controls';        
            jQuery('#sequence_control').append(zoom_controls);
            if (zoom_controls.style.height == '100%') {
                jQuery('#sequence_controllers').css('left','5em').css('position','absolute');
                zoom_controls.style.position = 'absolute';
            }
            zoom_controls.style.zIndex = 2;
            var dragger = new GOMap.Diagram.Dragger();
            dragger.applyToElement(document.getElementById('condensed_container').parentNode);
            dragger.targetElement = document.getElementById('condensed_container').parentNode;
            MASCP.renderer.zoom = 0.81;
            MASCP.renderer.padding = 10;
            jQuery(MASCP.renderer).bind('sequenceChange', function() {
                var zoomFactor = document.width / (2 * MASCP.renderer.sequence.length);
                MASCP.renderer.defaultZoom = zoomFactor;
                MASCP.renderer.zoom = zoomFactor;
                dragger.applyToElement(MASCP.renderer._canvas);
            })
        }
        
        var tissue_map = null;
        
        if (typeof GOMap != 'undefined') {
            var map_container = jQuery('<div style="position: relative; height: 0px; width: 100%; margin-bottom: 2px; overflow: hidden;"></div>');
            tissue_map = new GOMap.Diagram('tissue.svg', { 'load' : (function() {
                map_container.css({'height': '100%','overflow':'visible'});
            })});

            tissue_map.appendTo(map_container[0]);
            jQuery('#atproteome_map').append(map_container);                
        }
        
        var rendering_readers = [];
        
        if(!Array.indexOf){
            Array.prototype.indexOf = function(obj){
                for(var i=0; i<this.length; i++){
                    if(this[i]==obj){
                        return i;
                    }
                }
                return -1;
            }
        }
        
        jQuery(MASCP.renderer).bind('resultsRendered',function(renderer) {

            rendering_readers.splice(rendering_readers.indexOf(renderer),1);

            if (rendering_readers.length > 0) {
                return;
            }
            MASCP.renderer.createLayerCheckbox('phosphat_theoretical',jQuery('#phosphat_theoretical input')[0],true);
            MASCP.renderer.createLayerCheckbox('phosphat_experimental',jQuery('#phosphat_experimental input')[0],true);      
            if (MASCP.getGroup('promex_experimental').size() > 1) {
                MASCP.renderer.createLayerCheckbox('promex_controller',jQuery('#promex_placeholder input')[0],true);      
            } else {
                MASCP.renderer.createGroupCheckbox('promex_experimental',jQuery('#promex_placeholder input')[0],true);                
            }
            
            if (MASCP.getGroup('atproteome').size() > 1) {
                MASCP.renderer.createLayerCheckbox('atproteome_controller',jQuery('#atproteome_placeholder input')[0],true);
            } else {
                MASCP.renderer.createGroupCheckbox('atproteome',jQuery('#atproteome_placeholder input')[0],true);
            }
            
            MASCP.renderer.createLayerCheckbox('hydropathy',jQuery('#hydropathy input')[0],true);            
            
            var tweak_track_order = function(array) {
                if (array.splice && array.indexOf) {
                    if (MASCP.getGroup('atproteome').size() > 1) {
                        array.splice(array.indexOf('atproteome_placeholder'),0,'atproteome_controller','atproteome');
                    } else {
                        array.splice(array.indexOf('atproteome_placeholder'),0,'atproteome');                        
                    }
                    if (MASCP.getGroup('promex_experimental').size() > 1) {
                        array.splice(array.indexOf('promex_placeholder'),0,'promex_controller','promex_experimental');
                    } else {
                        array.splice(array.indexOf('promex_placeholder'),0,'promex_experimental');
                    }
                }
                return array;
            };
            
            MASCP.renderer.trackOrder = tweak_track_order(jQuery('#sequence_controllers').sortable({
                update: function(event, ui) {
                    if (MASCP.renderer.trackOrder) {
                        MASCP.renderer.trackOrder = tweak_track_order(jQuery('#sequence_controllers').sortable('toArray'));
                    }
                    if (MASCP.renderer.setTrackOrder) {
                        MASCP.renderer.setTrackOrder(tweak_track_order(jQuery('#sequence_controllers').sortable('toArray')));
                    }
                },
            }).sortable('toArray'));
            
            if (MASCP.renderer.setTrackOrder) {
                MASCP.renderer.setTrackOrder(MASCP.renderer.trackOrder);                
            }
        });
        
        jQuery(MASCP).bind('layerRegistered', function(e,layer) {

            var mouse_out_func = function(e,ev) {
                jQuery('#atproteome_map')[0].style.position = 'fixed';                
                jQuery('#atproteome_map')[0].style.top = '-10000px';                
                jQuery('#atproteome_map')[0].style.left = '-10000px';                                
            };
            
            if (layer.group && layer.group.name == 'atproteome') {
                jQuery(layer).bind('mousemove',function(e,orig_event,source) {
                    var ev = orig_event;
                    if (! ev) {
                        ev = e;
                    }
                    jQuery('#atproteome_map')[0].style.position = 'fixed';
                    jQuery('#atproteome_map')[0].style.zIndex = 1;
                    jQuery('#atproteome_map')[0].style.height = 100+'px';
                    jQuery('#atproteome_map')[0].style.width = 150+'px';
                    var offset = jQuery('#condensed_container').offset();
                    jQuery('#atproteome_map')[0].style.top = (offset.top + ev.pageY+10 - jQuery(document).scrollTop())+'px';
                    jQuery('#atproteome_map')[0].style.left = (offset.left + ev.pageX+10 - jQuery(document).scrollLeft())+'px';
                    if (source == 'SequenceRenderer') {
                        jQuery('#atproteome_map')[0].style.top = ev.pageY+'px';
                        jQuery('#atproteome_map')[0].style.left = ev.pageX+'px';
                    }
                    tissue_map.hideAllKeywords();
                    tissue_map.showKeyword('border');
                    if ( tissue_map.showKeyword(layer.data['po']) ) {
                        tissue_map.zoomToKeyword(layer.data['po']);
                    } else {
                        mouse_out_func();
                    }
                });
            
                jQuery(layer).bind('mouseup',mouse_out_func);
                jQuery(layer).bind('mouseleave',mouse_out_func);                                
                jQuery(layer).bind('mouseout',mouse_out_func);                                

            }
        });

        jQuery(MASCP.renderer).bind('sequenceChange',function() {
            if (MASCP.renderer.sequence == '') {
                return;
            }
            
            var agi = jQuery('#agi')[0].value;
            MASCP.renderer.reset();
            if (MASCP.renderer.createHydropathyLayer) {
                MASCP.renderer.createHydropathyLayer(4);
                jQuery('#hydropathy').show();
            }
            
            if (MASCP.SubaReader.existing_map) {
                log("Removing existing map");
                MASCP.SubaReader.existing_map.destroy();
                MASCP.SubaReader.existing_map = null;
            }
    
            if (MASCP.AtProteomeReader.existing_map) {
                log("Removing existing map");
                MASCP.AtProteomeReader.existing_map.destroy();      
                MASCP.AtProteomeReader.existing_map = null;
            }

            var suba = new MASCP.SubaReader(agi);
            suba.retrieve();
            jQuery(suba).bind('resultReceived',function() {
                jQuery('#suba_results').text('');
                jQuery('#suba_results').append(this.result.render());               
                if (this.result._map) {
                    MASCP.SubaReader.existing_map = this.result._map;
                    var controller = this.result.mapController();
                    controller.setAttribute('id','suba_controller');
                    jQuery('#suba_results').append(controller);
                }
            });

            var phosphat = new MASCP.PhosphatReader(agi,'../proxy.pl');
            phosphat.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(phosphat);
            phosphat.bind('resultReceived',function() {
                if (this.result.getAllExperimentalPositions().length > 0) {                 
                    jQuery('#phosphat_experimental').show();
                } else if (this.result.getAllPredictedPositions().length > 0) {
                    jQuery('#phosphat_theoretical').show();                 
                }
            });
            jQuery('#phoshpat_experimental input').attr('checked',false);
            jQuery('#phosphat_theoretical input').attr('checked',false);            
            jQuery('#phosphat_experimental').hide();
            jQuery('#phosphat_theoretical').hide();
            phosphat.retrieve();
            
            var promex = new MASCP.PromexReader(agi);
            promex.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(promex);
            promex.bind('resultReceived',function() {
                jQuery(MASCP.getLayer('promex_controller')).each(function() {
                    if (MASCP.renderer.applyStyle) {
                        MASCP.renderer.applyStyle(this.name,'cursor: pointer');
                    }
                });

                if (this.result.getPeptides().length > 0) {
                    jQuery('#promex_placeholder').show();
                }
            });
            jQuery('#promex_placeholder').hide();
            promex.retrieve();

            var atproteome = new MASCP.AtProteomeReader(agi);
            atproteome.registerSequenceRenderer(MASCP.renderer);
            rendering_readers.push(atproteome);
            atproteome.bind('resultReceived',function() {

                if (this.result == null) {
                    return;
                }
                
                jQuery(MASCP.getLayer('atproteome_controller')).each(function() {
                    if (MASCP.renderer.applyStyle) {
                        MASCP.renderer.applyStyle(this.name,'cursor: pointer');
                    }
                });
                jQuery('#atproteome_placeholder').show();
            });
            jQuery('#atproteome_placeholder').hide();
            atproteome.retrieve();
        });
        
        // Trigger the change event on page load
        jQuery('#agi').trigger('change');
    });

    jQuery('#agi').bind('change',function() {
        var agi = this.value;
        if (agi.length < 1) {
            return;
        }

        for (var groupname in MASCP.groups) {
            MASCP.renderer.hideGroup(groupname);
        }
        
        for (var layername in MASCP.layers) {
            MASCP.renderer.hideLayer(layername);
        }
        
        jQuery('#selected_agi').text("Data for "+agi);
        var reader = new MASCP.TairReader(agi,'../proxy.pl');
        jQuery(reader).bind('resultReceived',function() {
            if (this.result.getSequence() == '') {
                return;
            }
            MASCP.renderer.setSequence(this.result.getSequence());
        });
        reader.retrieve();
    });
//]]>
</script>
</body>
</html>
